1  name: Android Build
 2  
 3  on:
 4    push:
 5      branches:
 6        - main
 7  
 8  jobs:
 9    build:
10      runs-on: ubuntu-22.04
11  
12      steps:
13        - name: Checkout code
14          uses: actions/checkout@v4
15  
16        - name: Set up Java 17
17          uses: actions/setup-java@v4
18          with:
19            distribution: 'temurin'
20            java-version: '17'
21  
22        - name: Install system dependencies
23          run: |
24            sudo apt-get update
25            sudo apt-get install -y \
26                wget \
27                unzip \
28                zlib1g-dev \
29                libncurses5-dev \
30                libffi-dev \
31                libssl-dev \
32                build-essential \
33                python3-venv
34  
35        - name: Setup Android SDK
36          run: |
37            mkdir -p $HOME/android-sdk/cmdline-tools
38            wget https://dl.google.com/android/repository/commandlinetools-linux-10406996_latest.zip -O commandlinetools.zip
39            unzip commandlinetools.zip -d $HOME/android-sdk/cmdline-tools
40            mkdir -p $HOME/android-sdk/cmdline-tools/latest
41            mv $HOME/android-sdk/cmdline-tools/cmdline-tools/* $HOME/android-sdk/cmdline-tools/latest/
42            rm commandlinetools.zip
43            
44            echo "ANDROID_HOME=$HOME/android-sdk" >> $GITHUB_ENV
45            echo "ANDROID_SDK_ROOT=$HOME/android-sdk" >> $GITHUB_ENV
46            echo "PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH" >> $GITHUB_ENV
47            echo "JAVA_HOME=$JAVA_HOME_17_X64" >> $GITHUB_ENV
48  
49        - name: Verify sdkmanager installation
50          run: |
51            if [ ! -d "$HOME/android-sdk/cmdline-tools/latest/bin" ]; then
52              echo "Directory $HOME/android-sdk/cmdline-tools/latest/bin does not exist"
53              exit 1
54            fi
55            ls -la $HOME/android-sdk/cmdline-tools/latest/bin/
56            if [ ! -f "$HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager" ]; then
57              echo "sdkmanager not found in $HOME/android-sdk/cmdline-tools/latest/bin"
58              exit 1
59            fi
60  
61        - name: Install Android components
62          run: |
63            yes | $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager --licenses
64            $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0"
65  
66        - name: Download and setup Android NDK
67          run: |
68            mkdir -p $HOME/android-sdk/ndk/27.2.12479018
69            wget https://dl.google.com/android/repository/android-ndk-r25b-linux.zip -O $HOME/android-sdk/ndk/android-ndk-r25b-linux.zip
70            unzip -q $HOME/android-sdk/ndk/android-ndk-r25b-linux.zip -d $HOME/android-sdk/ndk/27.2.12479018
71            mv $HOME/android-sdk/ndk/27.2.12479018/android-ndk-r25b/* $HOME/android-sdk/ndk/27.2.12479018/
72            rm -rf $HOME/android-sdk/ndk/27.2.12479018/android-ndk-r25b
73            rm -rf $HOME/android-sdk/ndk/android-ndk-r25b-linux.zip
74            echo "PATH=$ANDROID_HOME/ndk/27.2.12479018:$PATH" >> $GITHUB_ENV
75  
76        - name: Install Buildozer
77          run: |
78            python3 -m venv venv
79            source venv/bin/activate
80            pip install --upgrade pip
81            pip install buildozer==1.5.0 cython==0.29.36
82  
83        - name: Verify Buildozer Installation
84          run: |
85            source venv/bin/activate
86            buildozer --version
87  
88        - name: Configure buildozer.spec
89          run: |
90            source venv/bin/activate
91            if [ ! -f buildozer.spec ]; then
92              buildozer init
93            fi
94            
95            cat <<EOT > buildozer.spec
96            [app]
97            title = MyApp
98            package.name = myapp
99            package.domain = org.example
100           source.dir = .
101           version = 1.0
102           requirements = python3,kivy,sqlite3,pandas
103           android.ndk_path = \$ANDROID_HOME/ndk/27.2.12479018
104           android.sdk_path = \$ANDROID_HOME
105           android.sdk_build_tools = 34.0.0
106           android.api = 34
107           android.minapi = 21
108           android.permissions = WRITE_EXTERNAL_STORAGE,READ_EXTERNAL_STORAGE
109           EOT
110  
111        - name: Verify python-for-android directory
112          run: |
113            source venv/bin/activate
114            buildozer -v android update
115            if [ ! -d ".buildozer/android/platform/python-for-android" ]; then
116              echo "python-for-android directory does not exist"
117              exit 1
118            fi
119  
120        - name: Build APK
121          run: |
122            source venv/bin/activate
123            buildozer -v android clean
124            buildozer -v android debug
